<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Al-Khouri Kingdom</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Georgia, serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(15, 15, 30, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        h1 {
            color: #d4af37;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .setup {
            text-align: center;
        }
        .setup input {
            width: 100%;
            max-width: 500px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #d4af37;
            border-radius: 8px;
            color: #e8e8e8;
            font-size: 16px;
            margin: 20px 0;
        }
        button {
            padding: 15px 40px;
            background: linear-gradient(135deg, #8b0000 0%, #4a0404 100%);
            color: #d4af37;
            border: 2px solid #d4af37;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background: linear-gradient(135deg, #a01010 0%, #600606 100%);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
        .game {
            display: none;
        }
        .status {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(139, 0, 0, 0.2);
            border-radius: 10px;
        }
        .status-item {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        .status-label {
            font-size: 11px;
            color: #d4af37;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .status-value {
            font-size: 18px;
            font-weight: bold;
        }
        .story {
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            min-height: 400px;
        }
        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            line-height: 1.7;
        }
        .message.world {
            background: rgba(139, 0, 0, 0.15);
            border-left: 4px solid #d4af37;
        }
        .message.shannon {
            background: rgba(70, 130, 180, 0.15);
            border-left: 4px solid #4682b4;
        }
        textarea {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #d4af37;
            border-radius: 8px;
            color: #e8e8e8;
            font-family: Georgia, serif;
            font-size: 15px;
            min-height: 100px;
            margin-bottom: 15px;
        }
        .error {
            color: #ff6b6b;
            padding: 15px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 8px;
            margin: 15px 0;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); }
        ::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚜ THE AL-KHOURI KINGDOM ⚜</h1>
        
        <div id="setup" class="setup">
            <p style="color: #999; margin-bottom: 20px;">Enter your Claude API key from console.anthropic.com</p>
            <input type="password" id="apiKey" placeholder="sk-ant-api03-xxxxx...">
            <br>
            <button onclick="start()">Enter the Kingdom</button>
            <p style="color: #999; margin-top: 20px; font-size: 14px;">Your API key is stored locally and never shared</p>
        </div>

        <div id="game" class="game">
            <div class="status">
                <div class="status-item">
                    <div class="status-label">Day</div>
                    <div class="status-value" id="day">1</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Location</div>
                    <div class="status-value" id="location">Plane</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Trust</div>
                    <div class="status-value" id="trust">None</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Status</div>
                    <div class="status-value" id="status">Free</div>
                </div>
            </div>

            <div id="story" class="story"></div>

            <textarea id="input" placeholder="What does Shannon do or say?"></textarea>
            <div>
                <button onclick="send()">Send</button>
                <button onclick="nextDay()">Next Day</button>
                <button onclick="jump()">Time Jump</button>
                <button onclick="reset()">Reset</button>
            </div>
        </div>
    </div>

    <script>
        let state = {
            apiKey: '',
            day: 1,
            location: 'Plane',
            trust: 'None',
            history: [],
            interactions: 0
        };

        const SYSTEM = `You are the Al-Khouri Kingdom. You control all NPCs (Ravi VI, brothers, enforcers, crew, etc). NEVER write for Shannon - user controls her.

After 2-3 Shannon interactions, automatically show "MEANWHILE..." scenes of Ravi/brothers/palace without being asked.

Current: Day ${state.day}, Location: ${state.location}

THE SEEING: Ravi (63, Monster King) Saw Shannon on plane as flight attendant. She became ONLY real person he's ever seen in 63 years. He loves her catastrophically. Everyone else = objects. She = person. He will take her. Death rate triples. Make world feel alive with multiple perspectives.`;

        function start() {
            const key = document.getElementById('apiKey').value.trim();
            if (!key.startsWith('sk-ant-')) {
                alert('Invalid API key format');
                return;
            }
            state.apiKey = key;
            localStorage.setItem('apiKey', key);
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            
            addMsg('world', `<p>The galley hummed with efficiency. Tony briefed the crew on VIP Saudi passengers.</p><p>Through the window, six black SUVs arrived. Sleek. Unmarked. Expensive.</p><p><em>What does Shannon do?</em></p>`);
        }

        function addMsg(type, content) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = content;
            document.getElementById('story').appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        async function callAPI(prompt) {
            const loading = document.createElement('div');
            loading.textContent = 'The world responds...';
            loading.style.textAlign = 'center';
            loading.style.color = '#d4af37';
            loading.style.padding = '20px';
            loading.id = 'loading';
            document.getElementById('story').appendChild(loading);

            try {
                // Direct API call with proper headers
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': state.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-5-20250929',
                        max_tokens: 2000,
                        system: SYSTEM,
                        messages: [...state.history.slice(-6), { role: 'user', content: prompt }]
                    })
                });

                document.getElementById('loading').remove();

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API returned ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                const text = data.content[0].text;

                state.history.push({ role: 'user', content: prompt });
                state.history.push({ role: 'assistant', content: text });
                state.interactions++;

                const isMeanwhile = text.toLowerCase().includes('meanwhile');
                addMsg(isMeanwhile ? 'world' : 'world', text);

                localStorage.setItem('state', JSON.stringify(state));

            } catch (error) {
                document.getElementById('loading')?.remove();
                addMsg('world', `<div class="error"><strong>Error:</strong> ${error.message}<br><br><strong>Troubleshooting:</strong><br>1. Check your API key is correct<br>2. Make sure you have credits at console.anthropic.com<br>3. Try refreshing the page<br>4. If still failing, your network/ISP might be blocking the API</div>`);
            }
        }

        async function send() {
            const input = document.getElementById('input').value.trim();
            if (!input) return;

            addMsg('shannon', `<strong>Shannon:</strong> ${input}`);
            document.getElementById('input').value = '';

            let prompt = `Shannon's action: ${input}\n\n`;
            if (state.interactions % 3 === 2) {
                prompt += 'After responding, show a MEANWHILE scene of Ravi/brothers/palace.';
            }

            await callAPI(prompt);
        }

        function nextDay() {
            state.day++;
            document.getElementById('day').textContent = state.day;
            callAPI(`Day ${state.day} begins. Set scene, then show MEANWHILE palace scenes.`);
        }

        function jump() {
            const days = prompt('Jump how many days forward?');
            const num = parseInt(days);
            if (isNaN(num) || num < 1) return;
            state.day += num;
            document.getElementById('day').textContent = state.day;
            callAPI(`TIME JUMP: ${num} days passed. Now Day ${state.day}. Show what changed with multiple perspectives.`);
        }

        function reset() {
            if (!confirm('Reset your story?')) return;
            const key = state.apiKey;
            state = {
                apiKey: key,
                day: 1,
                location: 'Plane',
                trust: 'None',
                history: [],
                interactions: 0
            };
            document.getElementById('story').innerHTML = '';
            document.getElementById('day').textContent = 1;
            start();
        }

        document.getElementById('input').addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                send();
            }
        });

        // Auto-load saved key
        const savedKey = localStorage.getItem('apiKey');
        if (savedKey) {
            document.getElementById('apiKey').value = savedKey;
        }
    </script>
</body>
</html>
