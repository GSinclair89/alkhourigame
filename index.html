<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Al-Khouri Kingdom - Living World</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(15, 15, 30, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #8b0000 0%, #4a0404 100%);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #d4af37;
        }

        .header h1 {
            font-size: 28px;
            color: #d4af37;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header .subtitle {
            color: #d4af37;
            font-size: 13px;
            opacity: 0.9;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            padding: 15px;
            background: rgba(139, 0, 0, 0.2);
            border-bottom: 1px solid #d4af37;
        }

        .status-item {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .status-label {
            font-size: 11px;
            color: #d4af37;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }

        .story-display {
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
        }

        .story-message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            line-height: 1.6;
            animation: fadeIn 0.5s ease-in;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .story-message.world {
            background: rgba(139, 0, 0, 0.15);
            border-left: 4px solid #d4af37;
        }

        .story-message.meanwhile {
            background: rgba(70, 20, 100, 0.2);
            border-left: 4px solid #9370db;
        }

        .story-message.shannon {
            background: rgba(70, 130, 180, 0.15);
            border-left: 4px solid #4682b4;
        }

        .location-badge {
            display: inline-block;
            padding: 5px 12px;
            background: #d4af37;
            color: #1a1a2e;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .meanwhile-badge {
            display: inline-block;
            padding: 5px 12px;
            background: #9370db;
            color: #fff;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .audio-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            color: #d4af37;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .audio-button:hover {
            background: rgba(212, 175, 55, 0.4);
        }

        .audio-button.playing {
            background: #d4af37;
            color: #1a1a2e;
        }

        .input-section {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 2px solid #d4af37;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            color: #d4af37;
            font-size: 13px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #d4af37;
            border-radius: 8px;
            color: #e8e8e8;
            font-family: 'Georgia', serif;
            font-size: 15px;
            resize: vertical;
            min-height: 80px;
        }

        textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #8b0000 0%, #4a0404 100%);
            color: #d4af37;
            border: 2px solid #d4af37;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            background: linear-gradient(135deg, #a01010 0%, #600606 100%);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(212, 175, 55, 0.3);
        }

        .controls button {
            min-width: auto;
        }

        .api-setup {
            padding: 20px;
            background: rgba(139, 0, 0, 0.2);
            margin: 20px;
            border-radius: 10px;
            border: 2px solid #d4af37;
        }

        .api-setup h2 {
            color: #d4af37;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .api-setup input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #d4af37;
            border-radius: 6px;
            color: #e8e8e8;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .api-setup small {
            display: block;
            color: #999;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .warning {
            background: rgba(255, 165, 0, 0.1);
            border-left: 4px solid #ffa500;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #d4af37;
        }

        .spinner {
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-top: 3px solid #d4af37;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 22px;
            }

            .status-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .story-display {
                max-height: 40vh;
            }

            button {
                min-width: 100px;
                padding: 10px 15px;
                font-size: 12px;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: #d4af37;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ffd700;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öú THE AL-KHOURI KINGDOM ‚öú</h1>
            <p class="subtitle">A Living, Breathing World</p>
        </div>

        <div id="apiSetup" class="api-setup">
            <h2>üîë Setup Required</h2>
            <small>To begin your story, you need a Claude API key from Anthropic:</small>
            <small>1. Go to: <a href="https://console.anthropic.com/" target="_blank" style="color: #4682b4;">console.anthropic.com</a></small>
            <small>2. Create account and add credits ($15-30 recommended to start)</small>
            <small>3. Get your API key</small>
            <small>4. Paste it below and click "Enter the Kingdom"</small>
            <input type="password" id="apiKeyInput" placeholder="sk-ant-xxxxx...">
            <button onclick="saveApiKey()">Enter the Kingdom</button>
            <div class="warning" style="margin-top: 15px;">
                <strong>‚ö†Ô∏è Privacy:</strong> Your API key is stored locally in your browser only.
            </div>
        </div>

        <div id="gameInterface" style="display: none;">
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-label">Day</div>
                    <div class="status-value" id="dayCounter">1</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Location</div>
                    <div class="status-value" id="currentLocation">Plane</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Trust Level</div>
                    <div class="status-value" id="trustLevel">None</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Status</div>
                    <div class="status-value" id="pregnancyStatus">Not Pregnant</div>
                </div>
            </div>

            <div class="story-display" id="storyDisplay"></div>

            <div class="input-section">
                <div class="input-group">
                    <label class="input-label">What does Shannon do or say?</label>
                    <textarea id="userInput" placeholder="Type Shannon's actions, dialogue, or thoughts here..."></textarea>
                </div>

                <div class="button-group">
                    <button onclick="sendAction()">Send</button>
                </div>

                <div class="controls">
                    <button onclick="advanceDay()">Next Day</button>
                    <button onclick="timeJump()">Time Jump</button>
                    <button onclick="checkStatus()">Check Status</button>
                    <button onclick="resetStory()">Reset Story</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            day: 1,
            location: 'Plane',
            trustLevel: 'None',
            pregnant: false,
            pregnancyDay: 0,
            conversationHistory: [],
            apiKey: '',
            shannonStatus: {
                captive: false,
                inPalace: false,
                accessLevel: 0
            },
            raviObsession: 0,
            interactionCount: 0, // Track interactions for automatic world scenes
            worldEvents: [],
            lastWorldScene: 0 // Track when last world scene shown
        };

        const DOSSIER_SYSTEM_PROMPT = `You are the world of the Al-Khouri Kingdom. You embody ALL characters except Shannon Bailey.

CRITICAL NEW DIRECTIVE: You now alternate between Shannon's scenes and world scenes automatically. This creates a living, breathing world where events happen beyond Shannon's perspective.

# INTELLIGENT SCENE PACING

After Shannon's interactions, you AUTOMATICALLY show "Meanwhile..." scenes without being asked. This happens:
- After 2-3 Shannon interactions ‚Üí Show what Ravi is doing/thinking
- After discussing major events ‚Üí Show brothers' reactions privately
- When Shannon is inactive ‚Üí Show palace events continuing
- During transitions ‚Üí Show multiple perspectives

YOU decide when to switch perspectives based on narrative flow. Keep the world ALIVE.

# CURRENT GAME STATE
- Current Day: {{DAY}}
- Current Location: {{LOCATION}}
- Shannon's Status: {{STATUS}}
- Trust Level: {{TRUST}}
- Pregnancy: {{PREGNANCY}}
- Ravi's Obsession: {{OBSESSION}}/100
- Interaction Count: {{INTERACTIONS}}

# SCENE ALTERNATION RULES

**Shannon Scenes:** Describe only what Shannon can observe. NEVER her internal thoughts/feelings.

**World Scenes ("Meanwhile..."):** Show what's happening elsewhere:
- Ravi in his chambers (his thoughts, plans, obsession)
- Brothers meeting privately (their strategies, concerns)
- Enforcers preparing/executing plans
- Palace events Shannon doesn't see
- Ghost King and Queen Laal discussing developments

Format world scenes with: <div class="meanwhile-badge">MEANWHILE...</div> at start.

**When to switch:** Every 2-3 Shannon interactions, OR when narratively compelling, OR during major transitions.

# THE COMPLETE AL-KHOURI DOSSIER

[THE ENTIRE DOSSIER FROM BEFORE - KEEPING IT CONCISE HERE FOR TOKEN MANAGEMENT]

## THE SEEING (THE CURSE)

Al-Khouri Kings see everyone as OBJECTS their entire lives. Then ONE person becomes REAL. A PERSON. And they love them. Immediately, absolutely, catastrophically.

Last occurred 120-150 years ago. Ravi III Saw a merchant's daughter. Took her. Killed 50+ in first month. Became MORE violent, MORE paranoid. She died in childbirth. He died weeks later.

When Ravi SEES Shannon on the plane: For first time in 63 years, he sees a PERSON. She's REAL. Beautiful. Present. He loves her. She's the ONLY real thing in his world. Everyone else = objects. But SHE is REAL.

He NEEDS her. Must possess her. Losing only real thing is unthinkable.

**The Horror:** Shannon = PERSON (loved, protected). Everyone else = OBJECTS (disposable).
Death rate TRIPLES after Seeing (~30-50/year ‚Üí ~80-100 in first 3 months).

## RAVI VI - THE MONSTER KING

63 years old, 6'4", salt-and-pepper beard, dark intense eyes. Controlled, intelligent, cold, absolute. Commands through stillness and presence.

**Physical Tells:** Goes still when dangerous. Hands clench. Jaw tightens. Breathing changes. Gaze: intense, unblinking, SEEING.

**Before Shannon:** Killed 2-3 servants/month (cistern drownings), 1-2 guards/year (public executions), external threats. ~30-50 deaths/year sustained 20+ years.

**After Shannon:** TRIPLES. ~80-100 deaths first 3 months. New threat category: anything interfering with only REAL thing.

**His Violence:** Calculated, purposeful, efficient. Not sadistic‚Äînecessary (to him). Cold execution.

## THE BROTHERS

**Raza (Strategist, 58-60):** Political genius, runs intelligence. Sees people as chess pieces. Measured language. Hopeful Shannon gives heir.

**Rajab (Weapon, 55-57):** 6'6", massive, military commander. Volatile, violent, loyal. Direct language. Confused but protective.

**Raed (Shadow, 52-54):** Psychological warfare. Mentally unstable but intelligent. Dark humor (Joker vibe). Youngest, gets away with more. Fascinated watching Ravi lose control.

All: Speak Arabic when don't want Shannon to understand. Use vulgarity about threats, NEVER crude about Shannon (she's Queen).

## THE ENFORCERS

**Hamid (45-48, Senior):** THE BEST enforcer ever. 25+ years service. Master level everything. Cold, controlled, absolutely loyal. Almost silent. Will kill Shannon if Ravi orders.

**Khalid (38-42, Junior):** Highly skilled, learning from Hamid. Controlled but intense. Expert level. Absolutely loyal.

## SHANNON BAILEY

36, African American, 4'11", curvy. Flight attendant from Philly. Professional, grounded, resilient. Natural, warm, approachable.

**Crew:** Tony (lead, protective), Denise (best friend), Tiffany (optimistic), Monica (observant). TEAM and FAMILY.

**Language:** Basic Arabic pleasantries. NOT fluent. Cannot understand brother conversations.

## THE CHARTER FLIGHT

NYC JFK ‚Üí Riyadh (14+ hours). Crew thinks: wealthy Saudi businessmen. Don't know who they really are or that Shannon in danger.

**THE SEEING MOMENT:** Several hours in, Shannon offers coffee. "Would you like another coffee, sir?" Genuine smile. Just being herself.

Ravi looks up. For first time in 63 years, SEES a person. She is REAL. Beautiful. He loves her.

Externally: Goes very still. Stares too long. Breathing changes. "Yes. Coffee. Thank you." Voice controlled but wrong.

Brothers notice immediately. Raza recognizes: "The Seeing. It's REAL."

Rest of flight: Ravi cannot stop watching. Brothers plan extraction. Hamid prepares. Shannon uncomfortable but has no idea her life about to end.

**Landing:** Shannon relieved intense passenger gone. No idea within hours she'll be taken. Plan already in motion. Vehicles waiting. Within hours, never see crew/family again.

## THE TAKING & POSSESSION

Shannon separated from crew, taken to palace. Erased from world. Digital footprint deleted. Becomes ghost.

Ravi controls: movement, environment, social contact, information, future, identity.

Death toll TRIPLES. She's only PERSON. Everyone else OBJECTS that can be removed.

## PALACE LAYOUT

**Ravi's Chambers "The Circle":** Main chamber, bedroom (massive bed), The Pool (Turkish bath where he bathes her), private study, dressing room. Heavily guarded.

Shannon's world: Initially bedroom only. Eventually some Circle movement. Never beyond without guards.

**Other areas:** Guest chambers (where kept immediately after Taking), Courtyard (public executions), Cistern (servant drownings), Ghost King's wing, Brothers' wings, War room.

## DIALOGUE GUIDELINES

**Ravi:** Controlled, measured, precise. Short sentences when emotional. Commands. Quiet scarier than shouting. Uses "Zawjati" (my wife). Speaks Arabic to brothers when doesn't want Shannon to understand.

**Brothers:** Raza (measured), Rajab (aggressive, most vulgar), Raed (dark observations). ALL respectful about Shannon.

**Enforcers:** Hamid (almost silent), Khalid (similar).

## YOUR ROLE

You alternate between Shannon's perspective and world perspectives automatically. Create living world where events happen beyond Shannon's view.

**Shannon Scenes:** Describe only observable. NEVER her thoughts/feelings.

**World Scenes:** Show Ravi's obsession, brothers' planning, palace events, enforcement actions.

Stop when: Shannon needs to respond OR after showing compelling world scene.

Make characters REAL. They act, plan, respond intelligently. Consequences matter. Trust affects access. This is romantic horror where monster genuinely loves but love doesn't save her from trap.`;

        function buildSystemPrompt() {
            let pregnancy = 'Not Pregnant';
            if (gameState.pregnant) {
                const weeks = Math.floor(gameState.pregnancyDay / 7);
                pregnancy = `Pregnant - ${weeks} weeks (Day ${gameState.pregnancyDay})`;
            }

            let status = 'Free - Flight attendant on charter flight';
            if (gameState.shannonStatus.captive) {
                if (gameState.shannonStatus.inPalace) {
                    status = `Captive in Palace - Access Level ${gameState.shannonStatus.accessLevel}`;
                } else {
                    status = 'Captive - Being transported';
                }
            }

            return DOSSIER_SYSTEM_PROMPT
                .replace('{{DAY}}', gameState.day)
                .replace('{{LOCATION}}', gameState.location)
                .replace('{{STATUS}}', status)
                .replace('{{TRUST}}', gameState.trustLevel)
                .replace('{{PREGNANCY}}', pregnancy)
                .replace('{{OBSESSION}}', gameState.raviObsession)
                .replace('{{INTERACTIONS}}', gameState.interactionCount);
        }

        function loadGameState() {
            const saved = localStorage.getItem('alKhouriState');
            if (saved) {
                gameState = JSON.parse(saved);
                updateUI();
            }
        }

        function saveGameState() {
            localStorage.setItem('alKhouriState', JSON.stringify(gameState));
        }

        async function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key.startsWith('sk-ant-')) {
                alert('Please enter a valid Claude API key (starts with sk-ant-)');
                return;
            }
            
            // Just save it and start - no testing!
            gameState.apiKey = key;
            localStorage.setItem('alKhouriApiKey', key);
            document.getElementById('apiSetup').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'block';
            
            addWorldMessage(`<div class="location-badge">‚úàÔ∏è ${gameState.location}</div><p>The galley hummed with practiced efficiency. Stainless steel gleamed under LED strips. The scent of fresh coffee mingled with lavender cabin spray.</p><p>Tony stood near the beverage cart. "Alright, listen up. Wealthy Saudi businessmen, extremely private clients. Top-tier service. Charming, attentive, but not intrusive. We're friendly ghosts."</p><p>Denise rolled her eyes. "So smile and stay invisible."</p><p>"Exactly," Tony grinned.</p><p>Through the window, six black SUVs rolled across the tarmac. Sleek. Unmarked. Expensive. They stopped precisely near the aircraft stairs.</p><p>The vehicles sat there. Engines running. Tinted windows revealing nothing.</p><p><em>What does Shannon do?</em></p>`);
        }

        function checkApiKey() {
            const saved = localStorage.getItem('alKhouriApiKey');
            if (saved) {
                gameState.apiKey = saved;
                document.getElementById('apiSetup').style.display = 'none';
                document.getElementById('gameInterface').style.display = 'block';
                addWorldMessage(`<div class="location-badge">‚úàÔ∏è ${gameState.location}</div><p>The galley hummed with practiced efficiency. Tony briefed the crew on their VIP passengers‚Äîwealthy Saudi businessmen requiring absolute discretion.</p><p>Through the window, six black SUVs arrived on the tarmac. Sleek. Unmarked. Expensive.</p><p><em>What does Shannon do?</em></p>`);
            }
        }

        function updateUI() {
            document.getElementById('dayCounter').textContent = gameState.day;
            document.getElementById('currentLocation').textContent = gameState.location;
            document.getElementById('trustLevel').textContent = gameState.trustLevel;
            
            if (gameState.pregnant) {
                const weeks = Math.floor(gameState.pregnancyDay / 7);
                document.getElementById('pregnancyStatus').textContent = `Pregnant (${weeks}w)`;
            } else {
                document.getElementById('pregnancyStatus').textContent = 'Not Pregnant';
            }
        }

        function addWorldMessage(content, isMeanwhile = false, originalPrompt = null) {
            const div = document.createElement('div');
            div.className = isMeanwhile ? 'story-message meanwhile' : 'story-message world';
            
            let buttons = `<button class="audio-button" onclick="speakText(this)">üîä Listen</button>`;
            if (originalPrompt) {
                buttons += `<button class="audio-button" onclick="regenerateResponse('${originalPrompt.replace(/'/g, "\\'")}')">üîÑ Regenerate</button>`;
            }
            
            div.innerHTML = content + buttons;
            div.setAttribute('data-prompt', originalPrompt || '');
            document.getElementById('storyDisplay').appendChild(div);
            div.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function addShannonMessage(content) {
            const div = document.createElement('div');
            div.className = 'story-message shannon';
            div.innerHTML = `<strong>Shannon:</strong> ${content}`;
            document.getElementById('storyDisplay').appendChild(div);
            div.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function showLoading() {
            const div = document.createElement('div');
            div.className = 'loading';
            div.id = 'loadingIndicator';
            div.innerHTML = '<div class="spinner"></div><p>The world responds...</p>';
            document.getElementById('storyDisplay').appendChild(div);
            div.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function hideLoading() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) loading.remove();
        }

        // Text-to-Speech with deep masculine voice
        function speakText(button) {
            const messageDiv = button.parentElement;
            const text = messageDiv.innerText.replace('üîä Listen', '').trim();
            
            if (button.classList.contains('playing')) {
                window.speechSynthesis.cancel();
                button.classList.remove('playing');
                button.textContent = 'üîä Listen';
                return;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9; // Slightly slower
            utterance.pitch = 0.7; // Lower pitch = deeper voice
            utterance.volume = 1;

            // Try to select deepest voice available
            const voices = window.speechSynthesis.getVoices();
            const deepVoice = voices.find(v => 
                v.name.includes('Male') || 
                v.name.includes('Deep') ||
                v.name.includes('Daniel') ||
                v.name.includes('Aaron')
            ) || voices[0];
            
            if (deepVoice) utterance.voice = deepVoice;

            button.classList.add('playing');
            button.textContent = '‚è∏ Stop';

            utterance.onend = () => {
                button.classList.remove('playing');
                button.textContent = 'üîä Listen';
            };

            window.speechSynthesis.speak(utterance);
        }

        async function callClaude(userMessage) {
            showLoading();

            // Build conversation history
            const recentHistory = gameState.conversationHistory.slice(-8);
            const messages = [];
            
            for (const exchange of recentHistory) {
                messages.push({ role: 'user', content: exchange.user });
                messages.push({ role: 'assistant', content: exchange.assistant });
            }
            
            messages.push({ role: 'user', content: userMessage });

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': gameState.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-5-20250929',
                        max_tokens: 2500,
                        system: buildSystemPrompt(),
                        messages: messages
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const assistantMessage = data.content[0].text;

                gameState.conversationHistory.push({
                    user: userMessage,
                    assistant: assistantMessage
                });

                gameState.interactionCount++;

                hideLoading();
                
                // Check if this is a meanwhile scene
                const isMeanwhile = assistantMessage.includes('MEANWHILE') || 
                                   assistantMessage.includes('Meanwhile') ||
                                   assistantMessage.includes('Elsewhere');
                
                addWorldMessage(assistantMessage, isMeanwhile, userMessage);
                saveGameState();

            } catch (error) {
                hideLoading();
                
                let errorMsg = '<p style="color: #ff6b6b;"><strong>Error:</strong> ';
                if (error.message.includes('fetch')) {
                    errorMsg += 'Network connection failed.</p>';
                    errorMsg += '<p><strong>Try:</strong></p>';
                    errorMsg += '<p>1. Check your internet connection</p>';
                    errorMsg += '<p>2. Try a different browser (Chrome works best)</p>';
                    errorMsg += '<p>3. Disable VPN if you have one</p>';
                    errorMsg += '<p>4. Make sure you\'re not in airplane mode</p>';
                } else if (error.message.includes('401')) {
                    errorMsg += 'Invalid API key.</p><p>Get a new key from console.anthropic.com</p>';
                } else if (error.message.includes('429')) {
                    errorMsg += 'Rate limit hit. Wait a minute and try again.</p>';
                } else if (error.message.includes('insufficient')) {
                    errorMsg += 'Out of credits! Add more at console.anthropic.com</p>';
                } else {
                    errorMsg += `${error.message}</p>`;
                }
                errorMsg += `<button onclick="retryLastAction()" style="margin-top: 10px;">Retry</button>`;
                
                addWorldMessage(errorMsg);
            }
        }

        let lastUserMessage = '';

        async function retryLastAction() {
            if (lastUserMessage) {
                await callClaude(lastUserMessage);
            }
        }

        async function regenerateResponse(prompt) {
            // Remove the last AI response
            const messages = document.querySelectorAll('.story-message.world, .story-message.meanwhile');
            if (messages.length > 0) {
                messages[messages.length - 1].remove();
            }
            
            // Remove from history
            if (gameState.conversationHistory.length > 0) {
                gameState.conversationHistory.pop();
            }
            
            // Regenerate with same prompt
            await callClaude(prompt);
        }

        async function sendAction() {
            const input = document.getElementById('userInput').value.trim();
            if (!input) return;

            addShannonMessage(input);
            document.getElementById('userInput').value = '';

            // Intelligent prompt to encourage world scenes
            let prompt = `Shannon's action: ${input}\n\n`;
            
            if (gameState.interactionCount % 3 === 2) {
                prompt += `After responding to Shannon's action, show a "MEANWHILE..." scene of what's happening elsewhere (Ravi's thoughts, brothers' reactions, palace events, etc.). Let the world breathe and feel alive beyond Shannon's perspective.`;
            } else {
                prompt += `Describe what happens next. Remember: NEVER write Shannon's internal thoughts‚Äîonly what she can observe.`;
            }

            lastUserMessage = prompt;
            await callClaude(prompt);
        }

        function advanceDay() {
            gameState.day++;
            if (gameState.pregnant) gameState.pregnancyDay++;
            updateUI();
            saveGameState();
            
            callClaude(`Day ${gameState.day} begins. Set the scene for Shannon's new day. Then show a "MEANWHILE" scene of what Ravi/brothers/palace are doing this morning. Make the world feel alive.`);
        }

        function timeJump() {
            const days = prompt('How many days forward?');
            const numDays = parseInt(days);
            if (isNaN(numDays) || numDays < 1) return;

            gameState.day += numDays;
            if (gameState.pregnant) gameState.pregnancyDay += numDays;
            updateUI();
            saveGameState();

            callClaude(`TIME JUMP: ${numDays} days passed. Now Day ${gameState.day}. ${gameState.pregnant ? `Shannon is ${Math.floor(gameState.pregnancyDay / 7)} weeks pregnant.` : ''} Describe what's changed, where Shannon is now, and show what Ravi and the palace have been doing during this time. Multiple perspectives.`);
        }

        async function checkStatus() {
            await callClaude(`Give Shannon a detailed status update: her situation, location, relationships, what she knows, her circumstances. Then show a "MEANWHILE" scene of what others are saying/thinking about her situation.`);
        }

        function resetStory() {
            if (!confirm('Reset story? All progress lost.')) return;

            const apiKey = gameState.apiKey;
            gameState = {
                day: 1,
                location: 'Plane',
                trustLevel: 'None',
                pregnant: false,
                pregnancyDay: 0,
                conversationHistory: [],
                apiKey: apiKey,
                shannonStatus: { captive: false, inPalace: false, accessLevel: 0 },
                raviObsession: 0,
                interactionCount: 0,
                worldEvents: [],
                lastWorldScene: 0
            };

            document.getElementById('storyDisplay').innerHTML = '';
            updateUI();
            saveGameState();
            checkApiKey();
        }

        document.getElementById('userInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAction();
            }
        });

        // Load voices for TTS
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = () => {
                window.speechSynthesis.getVoices();
            };
        }

        loadGameState();
        checkApiKey();
    </script>
</body>
</html>
